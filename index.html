<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zekken Programming Language Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Zekken Programming Language Demo</h2>
    <textarea id="code" spellcheck="false">// Write Zekken code here
@println => |"Hello, Web!"|</textarea>
    <div class="button-row">
      <button id="runBtn">Run</button>
      <button id="resetBtn">Reset</button>
    </div>
    <pre id="output">(output will appear here)</pre>
  </div>

  <script type="module">
    import init, { run_zekken } from "./pkg/zekken.js";
    
    let ready = false;
    init("./pkg/zekken_bg.wasm").then(() => ready = true);

    const code = document.getElementById('code');
    const output = document.getElementById('output');

    // Syntax highlighting function
    function highlight(text) {
      return text
        // Comments
        .replace(/(\/\/.*$)/gm, '<span style="color:#6A9955;font-style:italic">$1</span>')
        // Built-in functions (@println etc)
        .replace(/(@[a-zA-Z_][a-zA-Z0-9_]*)/g, '<span style="color:#569CD6">$1</span>')
        // Keywords
        .replace(/\b(if|else|for|while|try|catch|return)\b/g, '<span style="color:#C678DD">$1</span>')
        .replace(/\b(use|include|export|func|let|const|from|in)\b/g, '<span style="color:#569CD6">$1</span>')
        // Types
        .replace(/\b(int|float|bool|string|arr|obj|fn)\b/g, '<span style="color:#4EC9B0">$1</span>')
        // Numbers
        .replace(/\b(\d+\.?\d*)\b/g, '<span style="color:#B5CEA8">$1</span>')
        // Strings
        .replace(/("(?:[^"\\]|\\.)*")/g, '<span style="color:#CE9178">$1</span>')
        .replace(/('(?:[^'\\]|\\.)*')/g, '<span style="color:#CE9178">$1</span>')
        // Operators
        .replace(/([+\-*/%=<>!|]+)/g, '<span style="color:#D4D4D4">$1</span>')
        // Booleans
        .replace(/\b(true|false)\b/g, '<span style="color:#569CD6">$1</span>')
        // Variables (must come last to not override keywords)
        .replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g, '<span style="color:#9CDCFE">$1</span>');
    }

    // Create a hidden div for syntax highlighting
    const highlighter = document.createElement('pre');
    highlighter.style.cssText = `
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 12px;
      background: transparent;
      color: transparent;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      font-family: inherit;
      font-size: inherit;
      z-index: 1;
    `;
    
    // Wrap code textarea in relative div
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position: relative;';
    code.parentNode.insertBefore(wrapper, code);
    wrapper.appendChild(code);
    wrapper.appendChild(highlighter);

    // Update highlighting on input
    function updateHighlight() {
      highlighter.innerHTML = highlight(code.value);
      highlighter.scrollTop = code.scrollTop;
      highlighter.scrollLeft = code.scrollLeft;
    }

    code.addEventListener('input', updateHighlight);
    code.addEventListener('scroll', () => {
      highlighter.scrollTop = code.scrollTop;
      highlighter.scrollLeft = code.scrollLeft;
    });

    // Initial highlight
    updateHighlight();

    function showOutput(text, isError = false) {
      output.innerHTML = text;
      output.className = isError ? "error" : "";
    }

    document.getElementById('runBtn').onclick = () => {
      if (!ready) {
        showOutput("WASM not loaded yet!", true);
        return;
      }
      try {
        const result = run_zekken(code.value);
        const isError = result && (
          result.includes("Error:") || 
          result.includes("Syntax Error") || 
          result.includes("Runtime Error") || 
          result.includes("Type Error")
        );
        showOutput(result || "(no output)", isError);
      } catch (e) {
        showOutput("Error: " + e.message || e, true);
      }
    };

    document.getElementById('resetBtn').onclick = () => {
      code.value = "// Write Zekken code here\n@println => |\"Hello, Web!\"|";
      showOutput("(output will appear here)");
    };
  </script>
</body>
</html>
