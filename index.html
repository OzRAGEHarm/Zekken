<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zekken Programming Language Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Zekken Programming Language Demo</h2>
    <div class="editor-wrapper" style="position:relative; width:100%; margin-bottom:16px;">
      <pre class="highlighted" id="highlighted" aria-hidden="true" style="margin:0; width:100%; min-height:180px; box-sizing:border-box; pointer-events:none;"></pre>
      <textarea id="code" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"
        style="background:transparent; color:#e0e0e0; caret-color:#ffb86c; position:absolute; top:0; left:0; width:100%; min-height:180px; height:100%; resize:vertical; z-index:2; border:none; outline:none; padding:12px; font-family:inherit; font-size:1.1em; box-sizing:border-box; overflow:auto;">
// Write Zekken code here
@println => |"Hello, Web!"|
</textarea>
    </div>
    <div class="button-row">
      <button id="runBtn">Run</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>
    <pre id="output">(output will appear here)</pre>
  </div>
  <script type="module">
    import init, { run_zekken } from "./pkg/zekken.js";
    let ready = false;
    init("./pkg/zekken_bg.wasm").then(() => {
      ready = true;
    });

    // --- Simple syntax highlighter for Zekken ---
    function highlightZekken(code) {
      // Escape HTML first!
      code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      // Order: comment, string, keyword, type, number, operator, variable
      code = code
        .replace(/(\/\/.*)/g, '<span class="hl-comment">$1</span>')
        .replace(/("(?:[^"\\]|\\.)*")/g, '<span class="hl-string">$1</span>')
        .replace(/'(?:[^'\\]|\\.)*'/g, m => `<span class="hl-string">${m}</span>`)
        .replace(/\b(let|const|func|return|if|else|for|while|try|catch|use|include|export|from|in)\b/g, '<span class="hl-keyword">$1</span>')
        .replace(/\b(int|float|bool|string|arr|obj|fn)\b/g, '<span class="hl-type">$1</span>')
        .replace(/\b(true|false)\b/g, '<span class="hl-type">$1</span>')
        .replace(/\b\d+\.\d+\b/g, '<span class="hl-number">$&</span>')
        .replace(/\b\d+\b/g, '<span class="hl-number">$&</span>')
        .replace(/([+\-*/%=<>!]+)/g, '<span class="hl-operator">$1</span>');
      return code;
    }

    // Sync textarea and highlighted pre
    const textarea = document.getElementById('code');
    const highlighted = document.getElementById('highlighted');
    function syncHighlight() {
      // Set value for highlight
      let code = textarea.value;
      highlighted.innerHTML = highlightZekken(code) + '<br>';
      // Sync scroll
      highlighted.scrollTop = textarea.scrollTop;
    }
    textarea.addEventListener('input', syncHighlight);
    textarea.addEventListener('scroll', () => {
      highlighted.scrollTop = textarea.scrollTop;
    });
    window.addEventListener('resize', syncHighlight);
    syncHighlight();

    // --- Output logic with ANSI color to HTML ---
    function ansiToHtml(text) {
      // Only basic color codes for errors (red, green, yellow, etc.)
      return text
        .replace(/\x1b\[1;31m/g, '<span style="color:#ff5555;font-weight:bold">') // red
        .replace(/\x1b\[1;32m/g, '<span style="color:#50fa7b;font-weight:bold">') // green
        .replace(/\x1b\[1;33m/g, '<span style="color:#f1fa8c;font-weight:bold">') // yellow
        .replace(/\x1b\[1;34m/g, '<span style="color:#8be9fd;font-weight:bold">') // blue
        .replace(/\x1b\[1;35m/g, '<span style="color:#bd93f9;font-weight:bold">') // magenta
        .replace(/\x1b\[1;37m/g, '<span style="color:#e0e0e0;font-weight:bold">') // white
        .replace(/\x1b\[1;41m/g, '<span style="background:#ff5555;color:#fff;font-weight:bold">') // red bg
        .replace(/\x1b\[38;2;106;153;85m/g, '<span style="color:#6a9955">') // comment
        .replace(/\x1b\[38;2;86;156;214m/g, '<span style="color:#569cd6">') // builtin
        .replace(/\x1b\[38;2;220;220;170m/g, '<span style="color:#dcdcaa">') // fn decl/call
        .replace(/\x1b\[38;2;198;120;221m/g, '<span style="color:#c678dd">') // control
        .replace(/\x1b\[38;2;212;212;212m/g, '<span style="color:#d4d4d4">') // operator
        .replace(/\x1b\[38;2;156;220;254m/g, '<span style="color:#9cdcfe">') // variable
        .replace(/\x1b\[38;2;78;201;176m/g, '<span style="color:#4ec9b0">') // type
        .replace(/\x1b\[38;2;181;206;168m/g, '<span style="color:#b5cea8">') // int/float
        .replace(/\x1b\[38;2;215;186;125m\x1b\[1m/g, '<span style="color:#d7ba7d;font-weight:bold">') // escape
        .replace(/\x1b\[38;2;206;145;120m/g, '<span style="color:#ce9178">') // string
        .replace(/\x1b\[0m/g, '</span>');
    }

    function showOutput(text, isError = false) {
      const output = document.getElementById('output');
      // If error, try to render ANSI color codes as HTML
      if (isError || /\x1b\[[0-9;]*m/.test(text)) {
        output.innerHTML = ansiToHtml(text);
      } else {
        output.textContent = text;
      }
      output.className = isError ? "error" : "";
    }

    document.getElementById('runBtn').onclick = () => {
      const code = textarea.value;
      if (!ready) {
        showOutput("WASM not loaded yet!", true);
        return;
      }
      try {
        const result = run_zekken(code);
        // If error detected by output, treat as error for coloring
        const isError = result && (result.includes("Error:") || result.includes("Syntax Error") || result.includes("Runtime Error") || result.includes("Type Error"));
        showOutput(result && result.trim() !== "" ? result : "(no output)", isError);
      } catch (e) {
        showOutput("Error: " + (e && e.message ? e.message : e), true);
      }
    };

    document.getElementById('resetBtn').onclick = () => {
      textarea.value = `// Write Zekken code here
@println => |"Hello, Web!"|
`;
      syncHighlight();
      showOutput("(output will appear here)");
    };
    // Initial highlight
    syncHighlight();
  </script>
</body>
</html>
